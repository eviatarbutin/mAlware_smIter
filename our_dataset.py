from torch.utils.data import Dataset
from torchvision import transforms
from PIL import Image, ImageOps
import json
import os

from constants import DIRECTORY_SEPERATOR

class OurDataset(Dataset):
    def __init__(self, json_path = None):
        super().__init__()
        self.data = []
        self.malware_dictionary = {}

    #returns a dictionary of an image with it's label in the index of the given key
    def __getitem__(self, key):
        if len(self.data) > key:
            return self.data[key]
        return "moshe"

    def __add__(self, path: str) -> bool:
        if not os.path.isfile(path):
            return False
        # The path supposed to look like this:
        # malimg_fixed_dataset_imgs\malware_family\image_name
        # or this:
        # malimg_fixed_dataset_imgs/malware_family/image_name
        dictionary = {}
        #getting the malware family from the path
        malware_family = path.split(DIRECTORY_SEPERATOR)[1]
        img = Image.open(path)
        img = ImageOps.grayscale(img)
        convert_tensor = transforms.ToTensor()

        img = convert_tensor(img)
        #putting identifyers into dictionary
        dictionary["class"] = malware_family
        if malware_family not in self.malware_dictionary.keys():
            self.malware_dictionary[malware_family] = len(self.malware_dictionary)
        dictionary["tensor_class"] = self.malware_dictionary[malware_family]
        dictionary["image"] = img
        #saving the dictionary
        self.data.append(dictionary)
        return True

    # was used to put a dataset to a json file to save time 
    # with the old version of the dataset
    # now unused
    def create_dataset_from_current_data(self, path: str):
        with open(path, "w") as fp:
            json.dump(self.data, fp)

    def get_family_based_on_index(self,index):
        return list(self.malware_dictionary.keys())[list(self.malware_dictionary.values()).index(index)]  # Prints george


    #returning the length of the dataset
    def __len__(self,):
        return len(self.data)


if __name__ == "__main__":
    pass